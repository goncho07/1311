#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PEEPOS Frontend - Suite de Testing Completa
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# Ejecuta todos los tests y validaciones de cรณdigo frontend
#
# Uso:
#   ./test-suite.sh [opciones]
#
# Opciones:
#   --quick         Solo tests rรกpidos
#   --coverage      Generar reporte de cobertura
#   --e2e           Incluir tests E2E (Playwright)
#   --ci            Modo CI/CD (sin interacciรณn)
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

# Colores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() { echo -e "${BLUE}โน๏ธ  $1${NC}"; }
log_success() { echo -e "${GREEN}โ $1${NC}"; }
log_warning() { echo -e "${YELLOW}โ๏ธ  $1${NC}"; }
log_error() { echo -e "${RED}โ $1${NC}"; }

# Configuraciรณn
QUICK_MODE=false
COVERAGE=false
RUN_E2E=false
CI_MODE=false

# Parsear argumentos
for arg in "$@"; do
    case $arg in
        --quick) QUICK_MODE=true ;;
        --coverage) COVERAGE=true ;;
        --e2e) RUN_E2E=true ;;
        --ci) CI_MODE=true ;;
    esac
done

# Banner
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                                                           โ"
echo "โ       ๐งช  PEEPOS FRONTEND TESTING SUITE  ๐งช              โ"
echo "โ                                                           โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar que estamos en el directorio correcto
if [ ! -f "package.json" ]; then
    log_error "Este script debe ejecutarse desde el directorio frontend/"
    exit 1
fi

# Contadores
TESTS_PASSED=0
TESTS_FAILED=0

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. Verificar dependencias
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
log_info "Verificando dependencias..."

if [ ! -d "node_modules" ]; then
    log_warning "node_modules no existe, instalando dependencias..."
    npm ci
fi

log_success "Dependencias verificadas"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. Linter (ESLint)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
log_info "1/7 - Ejecutando ESLint..."
log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

npm run lint
if [ $? -eq 0 ]; then
    log_success "ESLint: PASSED"
    ((TESTS_PASSED++))
else
    log_error "ESLint: FAILED"
    ((TESTS_FAILED++))
    if $CI_MODE; then
        exit 1
    fi
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. TypeScript Check
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if ! $QUICK_MODE; then
    echo ""
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    log_info "2/7 - Verificando TypeScript..."
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

    npx tsc --noEmit
    if [ $? -eq 0 ]; then
        log_success "TypeScript: PASSED"
        ((TESTS_PASSED++))
    else
        log_error "TypeScript: FAILED"
        ((TESTS_FAILED++))
        if $CI_MODE; then
            exit 1
        fi
    fi
else
    log_warning "Saltando TypeScript check (modo rรกpido)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4. Unit Tests (Vitest)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
log_info "3/7 - Ejecutando Unit Tests (Vitest)..."
log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if $COVERAGE; then
    npm run test -- --coverage
else
    npm run test
fi

if [ $? -eq 0 ]; then
    log_success "Unit Tests: PASSED"
    ((TESTS_PASSED++))
else
    log_error "Unit Tests: FAILED"
    ((TESTS_FAILED++))
    if $CI_MODE; then
        exit 1
    fi
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 5. E2E Tests (Playwright) - Solo si se solicita
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if $RUN_E2E; then
    echo ""
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    log_info "4/7 - Ejecutando E2E Tests (Playwright)..."
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

    if [ ! -d "playwright" ]; then
        log_warning "Playwright no estรก configurado, saltando E2E tests"
    else
        npm run test:e2e
        if [ $? -eq 0 ]; then
            log_success "E2E Tests: PASSED"
            ((TESTS_PASSED++))
        else
            log_error "E2E Tests: FAILED"
            ((TESTS_FAILED++))
            if $CI_MODE; then
                exit 1
            fi
        fi
    fi
else
    log_warning "Saltando E2E tests (usa --e2e para ejecutarlos)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 6. Build Test
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if ! $QUICK_MODE; then
    echo ""
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    log_info "5/7 - Verificando Build de Producciรณn..."
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

    npm run build
    if [ $? -eq 0 ]; then
        log_success "Build: PASSED"
        ((TESTS_PASSED++))

        # Mostrar tamaรฑo del build
        if [ -d "dist" ]; then
            BUILD_SIZE=$(du -sh dist | cut -f1)
            log_info "Tamaรฑo del build: $BUILD_SIZE"

            # Verificar que el build no sea demasiado grande
            SIZE_IN_MB=$(du -sm dist | cut -f1)
            if [ $SIZE_IN_MB -gt 10 ]; then
                log_warning "El build es grande ($BUILD_SIZE). Considera optimizar."
            fi
        fi
    else
        log_error "Build: FAILED"
        ((TESTS_FAILED++))
        if $CI_MODE; then
            exit 1
        fi
    fi
else
    log_warning "Saltando Build test (modo rรกpido)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 7. Security Audit
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if ! $QUICK_MODE; then
    echo ""
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    log_info "6/7 - Ejecutando Security Audit..."
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

    npm audit --production --audit-level=moderate
    if [ $? -eq 0 ]; then
        log_success "Security Audit: PASSED"
        ((TESTS_PASSED++))
    else
        log_warning "Security Audit: VULNERABILITIES FOUND"
        log_info "Ejecuta 'npm audit fix' para intentar corregir automรกticamente"
    fi
else
    log_warning "Saltando Security Audit (modo rรกpido)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 8. Bundle Size Analysis (opcional)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if $COVERAGE && [ -d "dist" ]; then
    echo ""
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    log_info "7/7 - Analizando tamaรฑo del bundle..."
    log_info "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

    log_info "Archivos mรกs grandes:"
    find dist -type f -name "*.js" -exec du -h {} \; | sort -rh | head -10

    log_info ""
    log_info "Estadรญsticas por tipo de archivo:"
    echo "JavaScript:"
    find dist -type f -name "*.js" -exec du -ch {} + | grep total
    echo "CSS:"
    find dist -type f -name "*.css" -exec du -ch {} + | grep total 2>/dev/null || echo "0B"
    echo "Assets:"
    find dist -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" \) -exec du -ch {} + | grep total 2>/dev/null || echo "0B"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Generar reporte de cobertura
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if $COVERAGE; then
    echo ""
    log_success "Reporte de cobertura generado en: coverage/index.html"
    log_info "Abre el reporte con: open coverage/index.html"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Resumen Final
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    RESUMEN DE TESTS                       โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

TOTAL_TESTS=$((TESTS_PASSED + TESTS_FAILED))

echo "Tests ejecutados: $TOTAL_TESTS"
echo ""

if [ $TESTS_PASSED -gt 0 ]; then
    log_success "Tests exitosos: $TESTS_PASSED"
fi

if [ $TESTS_FAILED -gt 0 ]; then
    log_error "Tests fallidos: $TESTS_FAILED"
fi

echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    log_success "ยกTodos los tests pasaron exitosamente! ๐"
    echo ""
    exit 0
else
    log_error "Algunos tests fallaron. Revisa los errores arriba."
    echo ""
    exit 1
fi
